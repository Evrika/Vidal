<div class="block">
	<div class="block-head atc-tree">
		Список кодов АТХ
	</div>

	<div id="tree_placeholder">
		<div class="ajax-loader"></div>
	</div>
</div>


<script src="{{ asset('bundles/vidalmain/treeview/jquery.treeview.js') }}" type="text/javascript"></script>
<script type="text/javascript">
	$(document).ready(function() {
		$.getJSON(Routing.generate('atc_ajax'), null, function(html) {
			$('#tree_placeholder').html(html);

			var $tree = $('#tree_atc');

			$tree.treeview({
				animated:  "fast",
				collapsed: true,
				toggle:    false
			});

			$("#tree_expand").on('click', function() {
				$tree.find('ul').show();
				$tree.find('div.expandable-hitarea').removeClass('expandable-hitarea').addClass('collapsable-hitarea');
				$tree.find('div.lastExpandable-hitarea').removeClass('lastExpandable-hitarea').addClass('lastCollapsable-hitarea');
				$tree.find('li.expandable').removeClass('expandable').addClass('collapsable');
				$tree.find('li.lastExpandable').removeClass('lastExpandable').addClass('lastCollapsable');
				return false;
			});

			$('#tree_collapse').on('click', function() {
				$tree.find('ul').hide();
				$tree.find('div.collapsable-hitarea').removeClass('collapsable-hitarea').addClass('expandable-hitarea');
				$tree.find('div.lastCollapsable-hitarea').removeClass('lastCollapsable-hitarea').addClass('lastExpandable-hitarea');
				$tree.find('li.collapsable').removeClass('collapsable').addClass('expandable');
				$tree.find('li.lastCollapsable').removeClass('lastCollapsable').addClass('lastExpandable');
				return false;
			});

			$tree.on('click', 'i', function() {
				location.href = Routing.generate('atc_item', {'ATCCode': $(this).siblings('span').text()});
				return false;
			});

			{# Для дерева кодов АТС нужно раскрыть узлы найденных #}
			{% for code, atc in atcCodes %}
			$tree.find('li[data="' + '{{ code }}' + '"]').addClass('selected').parents('ul').each(function(index, element) {
				var $ul = $(element).show();
				var $li = $ul.parent('li');
				var $div = $li.children('div.hitarea');
				if ($li.hasClass('expandable')) {
					$li.removeClass('expandable').addClass('collapsable');
				}
				else if ($li.hasClass('lastExpandable')) {
					$li.removeClass('lastExpandable').addClass('lastCollapsable');
				}
				if ($div.hasClass('expandable-hitarea')) {
					$div.removeClass('expandable-hitarea').addClass('collapsable-hitarea');
				}
				else if ($div.hasClass('lastExpandable-hitarea')) {
					$div.removeClass('lastExpandable-hitarea').addClass('lastCollapsable-hitarea');
				}
			});
			{% endfor %}
		});
	});
</script>