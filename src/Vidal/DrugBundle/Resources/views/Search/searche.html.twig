{% extends 'VidalDrugBundle::vidal_layout.html.twig' %}


{% block vidal %}
	{% include 'VidalDrugBundle:Search:menu.html.twig' %}
	{% include 'VidalDrugBundle:Search:searche_form.html.twig' %}

	<div class="search-results">

	{# Найдено препаратов #}
	{% if productsPagination is defined %}
		{% if productsPagination is not empty %}
			<div class="block">
				<div class="block-anons">
					<div class="block-head">
						Найдено препаратов: <span>{{ productsPagination.totalItemCount }}</span>
					</div>
				</div>
			</div>

			<div class="navigation">
				{{ knp_pagination_render(productsPagination) }}
			</div>
			{% include 'VidalDrugBundle:Vidal:render_products.html.twig' with {'products':productsPagination.items} %}
			{% if productsPagination.totalItemCount > 15 %}
				<div class="navigation">
					{{ knp_pagination_render(productsPagination) }}
				</div>
			{% endif %}
		{% elseif t == 'product' %}
			<div class="no-results">
				Не найдено результатов по препарату <span>{{ q }}</span>
			</div>
		{% endif %}
	{% endif %}

	{# Найдено показаний МКБ-10 #}
	{% if nozologies is defined %}
		{% if nozologies is not empty %}
			<div class="block">
				<div class="block-anons">
					<div class="block-head">
						Найдено показаний: <span>{{ nozologies|length }}</span>
					</div>
				</div>
			</div>
			<table class="products-table">
				<tr class="products-table-header">
					<td style="width:78px">Код МКБ-10</td>
					<td>Показание</td>
				</tr>
				{% for nozology in nozologies %}
					<tr>
						<td>{{ nozology.Code }}</td>
						<td><a href="{{ path('nosology_item', {'Code':nozology.Code}) }}"
							   class="no-underline">{{ nozology.Name|raw }}</a></td>
					</tr>
				{% endfor %}
			</table>
		{% elseif t == 'nosology' %}
			<div class="no-results">
				Не найдено результатов по показанию <span>{{ q }}</span>
			</div>
		{% endif %}
	{% endif %}

	{# Найдено АТХ #}
	{% if atcCodes is defined %}
		<div class="block">
			{% if atcCodes is not empty %}
				<div class="block-head anons"
					 title="Анатомо-Терапевтически-Химическая (АТХ) система классификации (ATC)">
					Найдено кодов АТХ: <span>{{ atcCodes|length }}</span>
				</div>
				<table class="products-table">
					<tr class="products-table-header">
						<td style="width:12%">АТХ код</td>
						<td style="width:38%">Название</td>
						<td style="width:38%">Латинское название</td>
						<td style="width:12%">В группе</td>
					</tr>
					{% for code, atc in atcCodes %}
						<tr>
							<td>
								<a href="{{ path('atc', {'ATCCode':atc.ATCCode}) }}"
								   class="no-underline">{{ atc.ATCCode }}</a>
							</td>
							<td>{{ atc.RusName }}</td>
							<td>{{ atc.EngName }}</td>
							<td>
								{% if atc.ParentATCCode is not empty %}
									<a href="{{ path('atc', {'ATCCode':atc.ParentATCCode}) }}"
									   class="no-underline">{{ atc.ParentATCCode }}</a>
								{% endif %}
							</td>
						</tr>
					{% endfor %}
				</table>
			{% else %}
				<div class="no-results">
					Не найдено результатов по AТХ коду <span>{{ q }}</span>
				</div>
			{% endif %}
		</div>
	{% endif %}

	{# Найдено активных веществ #}
	{% if molecules is defined %}
		{% if molecules is not empty %}
			<div class="block">
				<div class="block-anons">
					<div class="block-head">
						Найдено активных веществ: <span>{{ molecules|length }}</span>
					</div>
				</div>
			</div>

			<table class="products-table">
				<tr class="products-table-header">
					<td width="23%">Активное вещ-во</td>
					<td width="23%">Латинское</td>
					<td width="30%" title="Международное непатентованное наименование (МНН)">МНН</td>
					<td>Входит в состав препаратов</td>
				</tr>
				{% for molecule in molecules %}
					<tr>
						<td>
							<a href="{{ path('molecule', {'MoleculeID':molecule.MoleculeID}) }}"
							   class="no-underline">{{ molecule.RusName|raw }}</a>
						</td>
						<td>{{ molecule.LatName|raw }}</td>
						<td>
							<a title="Международное непатентованное наименование (МНН)" href="{{ path('gnp') }}"
							   class="no-underline">{{ molecule.GNParent }}</a><br/>
							<span class="small italic">{{ molecule.description }}</span>
						</td>
						<td>
							<a href="{{ path('molecule_included', {'MoleculeID':molecule.MoleculeID}) }}"
							   class="no-underline">список</a>
						</td>
					</tr>
				{% endfor %}
			</table>
		{% elseif t == 'molecule' %}
			<div class="no-results">
				Не найдено результатов по активному веществу <span>{{ q }}</span>
			</div>
		{% endif %}
	{% endif %}

	{# Найдено БАДов #}
	{% if bads is defined %}
		<div class="block">
			<div class="block-anons">
				<div class="block-head">
					Найдено БАДов: <span>{{ bads|length }}</span>
				</div>
			</div>
		</div>
		{% include 'VidalDrugBundle:Vidal:render_products.html.twig' with {'products':bads, 'pictures':bad_pictures, 'companies':bad_companies, 'infoPages':bad_infoPages} %}
	{% endif %}

	{# Найдено клинико-фармакологических групп #}
	{% if clphgroups is defined %}
		{% if clphgroups is not empty %}
			<div class="block">
				<div class="block-anons">
					<div class="block-head">
						Найдено клинико-фармакологических групп: <span>{{ clphgroups|length }}</span>
					</div>
				</div>
			</div>
			<ul class="ul-style">
				{% for group in clphgroups %}
					<li><a href="{{ path('clphgroup', {'description':group.name}) }}"
						   class="no-underline">{{ group.description|raw }}</a></li>
				{% endfor %}
			</ul>
		{% elseif t == 'clphgroups' %}
			<div class="no-results">
				Не найдено клинико-фармакологических групп
			</div>
		{% endif %}
	{% endif %}

	{# Найдено фармако-терапевтических групп #}
	{% if phthgroups is defined %}
		{% if phthgroups is not empty %}
			<div class="block">
				<div class="block-anons">
					<div class="block-head">
						Найдено фармако-терапевтических групп: <span>{{ phthgroups|length }}</span>
					</div>
				</div>
			</div>
			<ul class="ul-style">
				{% for group in phthgroups %}
					<li><a href="{{ path('pharm_item', {'id':group.id}) }}"
						   class="no-underline">{{ group.Name|raw }}</a></li>
				{% endfor %}
			</ul>
		{% elseif t == 'phthgroup' %}
			<div class="no-results">
				Не найдено фармако-терапевтических групп
			</div>
		{% endif %}
	{% endif %}

	{# поиск по компании #}
	{% include 'VidalDrugBundle:Search:search_company.html.twig' %}

	{# Найдено заболеваний #}
	{% if articles is defined %}
		{% if articles is not empty %}
			<div class="block">
				<div class="block-anons">
					<div class="block-head">
						Найдено результатов по заболеваниям: <span>{{ articles|length }}</span>
					</div>
				</div>
			</div>
			{% include 'VidalDrugBundle:Vidal:render_articles.html.twig' %}
		{% else %}
			<div class="no-results">
				Не найдено результатов по заболеванию <span>{{ q }}</span>
			</div>
		{% endif %}
	{% endif %}

	{# если общий поиск не дал результатов #}
	{% if q is not empty
	and t == 'all'
	and (productsPagination is not defined or productsPagination is empty)
	and (molecules is not defined or molecules is empty)
	and (nozologies is not defined or nozologies is empty)
	and (search_infoPages is empty and search_companies is empty)
	and (bads is not defined) %}
		<div class="no-results">
			Не найдено результатов
		</div>
	{% endif %}

	</div>

{% endblock %}


{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" type="text/css" href="{{ asset('bundles/vidalmain/stylesheets/searche.css') }}"/>
{% endblock %}


{% block javascripts %}
	{{ parent() }}
	<script type="text/javascript">
		$(document).ready(function() {
			var $searcheForm = $('#searche_form');
			var $searcheSelect = $('#searche_form .search-type');
			var $searcheQuery = $('#searche_form .search-query');
			var $searcheOption = $('#searche_form .search-option');

			$searcheQuery.autocomplete({
				minLength: 2,
				source:    function(request, response) {
					$.ajax({
						url:      "http://twiga.vidal.ru:9200/website/autocompleteext/_search",
						type:     "POST",
						dataType: "JSON",
						data:     '{ "query":{"query_string":{"query":"' + request.term + '*"}}, "fields":["name"], "size":15, "highlight":{"fields":{"name":{}}} }',
						success:  function(data) {
							response($.map(data.hits.hits, function(item) {
								return {
									label: item.highlight.name,
									value: item.fields.name
								}
							}));
						}
					});
				}
			})
				.data("ui-autocomplete")._renderItem =
				function(ul, item) {
					return $("<li></li>").data("item.autocomplete", item).append("<a>" + item.label + "</a>").appendTo(ul);
				};

			$searcheSelect.chosen({disable_search: true});

			///////////////////////////////////////////////////////
//			$searcheOption.chosen();
//			$searcheSelect.change(function() {
//				var value = $searcheSelect.val();
//				if (value == 'molecule' || value == 'nozology' || value == 'atc' || value == 'company' || value == 'clphgroup' || value == 'phthgroup') {
//					$.getJSON(Routing.generate('search_options', {'type':value}), function(data) {
//						if (data.length > 0) {
//							$searcheOption.find('option').remove();
//							$.each(data, function(index, option) {
//								$searcheOption.append($('<option></option>').val(option.id).text(option.title));
//							});
//							$searcheOption.trigger("chosen:updated");
//						}
//					});
//				}
//			});
		});
	</script>
{% endblock %}