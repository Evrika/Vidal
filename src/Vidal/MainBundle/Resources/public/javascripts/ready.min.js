$(document).ready(function() {
	var types = {'product': 'препарат', 'molecule': 'вещество', 'atc': 'АТХ код', 'company': 'компания'};
	var type = 'all';
	var $selectType = $('#search_form .search-type');

	$('#search_form .search-query')
		.autocomplete({
			minLength: 2,
			source:    function(request, response) {
				var url = Routing.generate('elastic_autocomplete', {
					'type': $selectType.val(),
					'term': request.term.trim()
				});
				$.getJSON(url, function(data) {
					response($.map(data.hits.hits, function(item) {
						return {
							label: item.highlight.name,
							value: item._source.name,
							type:  item._source.type
						}
					}));
				});
			},
			select:    function(event, ui) {
				if (ui.item) {
					$('#bad').prop('checked')
						? window.location = Routing.generate('search', {'q': ui.item.value, 'bad': 'on'})
						: window.location = Routing.generate('search', {'q': ui.item.value});
				}
			}
		}).data("ui-autocomplete")._renderItem = function(ul, item) {
		return $('<li class="aut"></li>')
			.data("item.autocomplete", item)
			.append("<a>" + "<i>" + types[item.type] + "</i>" + item.label + "</a>")
			.appendTo(ul);
	};

	$('.admin-edit').click(function(e) {
		e.stopPropagation();
	});

	$('#search_form .search-type').chosen({disable_search: true});

	$(window).scroll(function() {
		if ($(this).scrollTop() > 100) {
			$('#top-link').fadeIn();
		} else {
			$('#top-link').fadeOut();
		}
	});

	$('#top-link').click(function() {
		$("html, body").animate({scrollTop: 0}, 600);
		return false;
	});

	$('a[href^="http"], a[href^="ftp"]').not('a[href^="http://vidal"]').click(function() {
		window.open(this.href, "");
		return false;
	});

	$('.tags > span').click(function(e) {
		e.stopPropagation();
		var $ul = $(this).find('> ul');
		$('.tags ul').not($ul).hide();
		$ul.toggle();
	});

	$('.tags ul').mouseover(function(e) {
		e.stopPropagation();
	}).click(function(e) {
		e.stopPropagation();
	});

	$('body').click(function() {
		$('.tags ul').hide();
	});

	$('.anons-footer').click(function(e) {
		var $announcement = $(this).toggleClass('expanded').closest('.announcement');
		$announcement.find('ul').slideToggle('fast');
		$announcement.find('.products').slideToggle('fast');
	});

	$('.text a').each(function() {
		var $link = $(this);
		var text = $link.text();
		var href = this.href;

		if (text.length > 70 && text.indexOf(' ') === -1) {
			var parts = text.split('/');
			text = parts.join('<span style="display:inline-block;width:0"></span>/');
			$link.html(text);
		}

		var index = href.indexOf('#_');
		if (index !== -1) {
			href = href.substring(index);
			this.href = href;
		}
	});

	$('.pharm-article .text a').each(function() {
		var href = $(this).attr('href');

		if (href.substr(0, 2) == '#_') {
			var data = $(this).closest('.pharm-article').attr('data');
			$(this).attr('data', data);
		}
	});

	$('.text a').click(function() {
		var id = $(this).attr('href').substring(2);
		var data = $(this).closest('.pharm-article').attr('data');
		if (data) {
			$(this).closest('.pharm-article').find('.spoiler-content').show()
				.closest('.spoiler').find('.spoiler-toggle').removeClass('show-icon').addClass('hide-icon');
		}
		else {
			$('#' + id).closest('.spoiler-content').show()
				.closest('.spoiler').find('.spoiler-toggle').removeClass('show-icon').addClass('hide-icon');
		}
	});

	$('.spoiler').click(function() {
		var $content = $(this).find('.spoiler-content');
		if ($content.css('display') == 'none') {
			$(this).find('.spoiler-toggle').removeClass('show-icon').addClass('hide-icon');
			$content.slideDown();
		}
		else {
			$(this).find('.spoiler-toggle').removeClass('hide-icon').addClass('show-icon');
			$content.slideUp();
		}
	});

	$('.block table, .text table, .text img, .block img').not('.products-table').each(function() {
		var $this = $(this);

		if ($this.width() > 520) {
			$this.wrap('<div class="table-wrap"><div>');
		}
	});

	$('.products-table-name .m').click(function(e) {
		e.stopPropagation();
		var $exclude = $(this).children('div');
		$('.products-table-name > div').not($exclude).hide();
		var $indication = $(this).siblings('div');
		$indication.css('display') == 'block'
			? $indication.hide()
			: $indication.show();
	});

	$('body').click(function() {
		$('.products-table-name > div').hide();
	});

	if (typeof($mobile) != 'undefined' && $mobile) {
		V.mobile.init();
	}
});

var V = {};

V.mobile = {
	init: function(){
		this.createMobileMenu();
		this.createSearch();
		this.createAuth();

		if ( $('.veterinar-menu').size() > 0 ) {
			this.veterenarMenu();
		}
		if ( $('#vidal .menu-drugs').size() > 0 ) {
			this.drugsMenu();
		}
		if ( $('.products-table').size() > 0 ) {
			this.productsTable();
		}
	},
	createMobileMenu : function(){
		var $obj = $('.mobile_menu'), $menuIcon = $('.mobile_menu_icon'), $menuClose = $('.mobile_menu_close'), $menuWrap = $('.mobile_menu_hidden'), $items = $('.sidebar-menu.ul'), $menuBig = $('.main > .menu');
		$menuBig.removeClass('menu-big').addClass('menu-small').appendTo( $menuWrap );
		$items.appendTo( '.mobile_menu_wrap' )
		$menuIcon.click(function(){
			$('body').css('overflow','hidden');
			$menuWrap.fadeIn();
		});
		$menuClose.click(function(){
			$('body').css('overflow','auto');
			$menuWrap.fadeOut();
		});
	},
	createSearch : function(){
		var $obj = $('.mobile_menu'), $searchIcon = $('.mobile_menu_search'), $searchClose = $('.mobile_search_close'), $searchWrap = $('.mobile_search_hidden'), $form = $('.header-3, .header-4');
		$form.appendTo( '.mobile_search_wrap' );
		$searchIcon.click(function(){
			$('body').css('overflow','hidden');
			$searchWrap.fadeIn();
		});
		$searchClose.click(function(){
			$('body').css('overflow','auto');
			$searchWrap.fadeOut();
		});
	},
	createAuth : function(){
		var $obj = $('.mobile_menu'), $authIcon = $('.mobile_menu_auth'), $authClose = $('.mobile_auth_close'), $authWrap = $('.mobile_auth_hidden'), $frame = $('.auth.auth-main'), $authActions = $('.go-registration');
		$authActions.appendTo($frame);
		$frame.appendTo( '.mobile_auth_wrap' );
		$authIcon.click(function(){
			$('body').css('overflow','hidden');
			$authWrap.fadeIn();
		});
		$authClose.click(function(){
			$('body').css('overflow','auto');
			$authWrap.fadeOut();
		});
	},
	veterenarMenu : function(){
		$html = '<select name"veterinar" id="veterinar_menu">';
		$('.tabs.veterinar-menu a').each(function(){
			$html += '<option value="'+$(this).attr('href')+'" '+( $(this).is('.active') ? 'selected="selected"' : '' )+'>'+$(this).text()+'</option>';
		});
		$html += '</select>';
		$('.tabs.veterinar-menu').replaceWith($html);
		$('#veterinar_menu').change(function(){
			document.location.href = $(this).val();
		});
	},
	drugsMenu : function(){
		$html = '<select name"drugs_menu" id="drugs_menu">';
		$('#vidal .menu-drugs .tabs a').each(function(){
			$html += '<option value="'+$(this).attr('href')+'" '+( $(this).is('.active') ? 'selected="selected"' : '' )+'>'+$(this).text()+'</option>';
		});
		$html += '</select>';
		$('#vidal .menu-drugs .tabs').replaceWith($html);
		$('#drugs_menu').change(function(){
			document.location.href = $(this).val();
		});
	},
	productsTable : function(){
		$('.products-table').width( $('body').innerWidth() - 20 );
		$('.products-table-name .m').unbind('click').click(function(e) {
			var $text = $(this).next('div:hidden').text();
			alert($text);
			return false;
		});
	}
}
